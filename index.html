<!DOCTYPE html>
<html lang="id">
<head>
    <title>Pintu - Investasi Bitcoin dan Crypto. Mudah. Praktis. Instan.</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="css/materials-icon.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection"/>
    <link rel="icon" href="img/favicon.png">
</head>
<body>

<div class="container" id="app">
    <img src="img/pintu_logo_text.png" alt="Pintu" style="margin-top: 5px" class="responsive-img center">

    <div class="row center">
        <div v-for="(it,index) in coinChips" :key="index" class="chip hoverable z-depth-1 waves-effect waves-ripple"
             :class="selectedColor(it)" @click="pick(it)" style="cursor: pointer">
            <img :src="it.icon" :alt="it.name">{{it.name}}
        </div>
    </div>

    <div class="row center">
        <!-- trending -->
        <div class="chip z-depth-1 hoverable waves-effect waves-ripple" style="cursor: pointer"
             @click="priceHour(selectedChip.symbol)">
            Jam: <span :class="trendingColor(price.hour.change)">{{price.hour.change|fmtPercent}}</span>
        </div>
        <div class="chip z-depth-1 hoverable waves-effect waves-ripple" style="cursor: pointer"
             @click="priceDay(selectedChip.symbol)">
            Hari: <span :class="trendingColor(price.day.change)">{{price.day.change|fmtPercent}}</span>
        </div>
        <div class="chip z-depth-1 hoverable waves-effect waves-ripple" style="cursor: pointer"
             @click="priceTimelapse(selectedChip.symbol, 'week')">
            Minggu: <span :class="trendingColor(price.week.change)">{{price.week.change|fmtPercent}}</span>
        </div>
        <div class="chip z-depth-1 hoverable waves-effect waves-ripple" style="cursor: pointer"
             @click="priceTimelapse(selectedChip.symbol, 'month')">
            Bulan: <span :class="trendingColor(price.month.change)">{{price.month.change|fmtPercent}}</span>
        </div>
        <div class="chip z-depth-1 hoverable waves-effect waves-ripple" style="cursor: pointer"
             @click="priceTimelapse(selectedChip.symbol, 'year')">
            Tahun: <span :class="trendingColor(price.year.change)">{{price.year.change|fmtPercent}}</span>
        </div>

        <!-- tinggi dan rendah -->
        <table class="striped highlight">
            <tbody>
            <tr>
                <td>Jam</td>
                <td class="green-text">{{price.hour.high|fmtNumber}}</td>
                <td class="red-text">{{price.hour.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Hari</td>
                <td class="green-text">{{price.day.high|fmtNumber}}</td>
                <td class="red-text">{{price.day.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Minggu</td>
                <td class="green-text">{{price.week.high|fmtNumber}}</td>
                <td class="red-text">{{price.week.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Bulan</td>
                <td class="green-text">{{price.month.high|fmtNumber}}</td>
                <td class="red-text">{{price.month.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Tahun</td>
                <td class="green-text">{{price.year.high|fmtNumber}}</td>
                <td class="red-text">{{price.year.low|fmtNumber}}</td>
            </tr>
            </tbody>
        </table>
        <!-- harga beli dan jual -->
        <div class="chip green lighten-1 z-depth-1 hoverable waves-effect waves-ripple" @click="refreshPrice"
             style="cursor: pointer">Beli: {{price.buy|fmtNumber}}
        </div>
        <div class="chip red lighten-1 z-depth-1 hoverable waves-effect waves-ripple" @click="refreshPrice"
             style="cursor: pointer">Jual: {{price.sell|fmtNumber}}
        </div>
    </div>

    <div class="row center">
        <a href="pintu.html" class="btn btn-floating green lighten-1 waves-effect waves-ripple"><i
                class="material-icons">laptop</i></a>
        <a href="#" class="btn btn-floating green lighten-1 waves-effect waves-ripple"
           @click.prevent="darkMode"><i class="material-icons">brightness_4</i></a>
        <a href="berita.html" class="btn btn-floating green lighten-1 waves-effect waves-ripple"><i
                class="material-icons">event</i></a>
    </div>
    <!-- kontak -->
    <div class="row center">
        <div class="chip hoverable z-depth-1 waves-effect waves-ripple" @click="contact" style="cursor: pointer">
            <img src="img/favicon.png" alt="jajanjawa">@jajanjawa
        </div>
        <br>
        <div class="chip hoverable z-depth-1 waves-effect waves-ripple" @click="invite" style="cursor: pointer">
            <img src="img/favicon.png" alt="Undangan">Kode Undangan: EXPLO190
        </div>
        <br>
        <div class="chip hoverable z-depth-1 waves-effect waves-ripple" style="cursor: pointer" @click="modal.open()">
            <img src="img/favicon.png" alt="Pintu">Buka Pintu
        </div>
    </div>

    <div id="confirm" class="modal">
        <div class="modal-content">
            apa kamu yakin untuk buka <span class="green-text">Pintu</span> ?
        </div>
        <div class="modal-footer">
            <a href="pintu://" class="modal-close waves-effect waves-green btn-flat">Ya</a>
            <a href="#" class="modal-close waves-effect waves-red btn-flat">Tidak</a>
        </div>
    </div>

</div>
<script src="js/materialize.min.js"></script>
<script src="js/vue.min.js"></script>
<script src="js/api.js"></script>
<script>
    function copyText(text) {
        let textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        textArea.remove();
    }

    function initPrice() {
        return {
            buy: 0, sell: 0, hour: {}, day: {}, week: {}, month: {}, year: {}
        };
    }

    let coinChips = [
        {icon: 'img/btc.webp', name: 'Bitcoin', symbol: 'btc'},
        {icon: 'img/eth.webp', name: 'Ethereum', symbol: 'eth'},
        {icon: 'img/usdt.webp', name: 'Tether', symbol: 'usdt'},
        {icon: 'img/bnb.webp', name: 'Binance Coin', symbol: 'bnb'},
        {icon: 'img/link.webp', name: 'Chainlink', symbol: 'link'},
        {icon: 'img/snx.webp', name: 'Synthetix', symbol: 'snx'},
        {icon: 'img/comp.webp', name: 'Compound', symbol: 'comp'},
        {icon: 'img/yfi.webp', name: 'Yearn.finance', symbol: 'yfi'},
        {icon: 'img/uni.webp', name: 'Uniswap', symbol: 'uni'},
        {icon: 'img/mkr.webp', name: 'Maker', symbol: 'mkr'}
    ]
    new Vue({
        el: '#app',
        data: {
            coinChips,
            selectedChip: null,
            price: initPrice(),
            modal: null
        },
        mounted() {
            let coin = localStorage.getItem('coin');
            if (coin) {
                let chip = this.coinChips.find(it => it.symbol === coin);
                this.pick(chip);
                this.priceHour(coin);
            } else {
                this.pick(this.coinChips[0]);
                this.priceHour('btc');
            }

            this.modal = M.Modal.init(document.querySelector('#confirm.modal'));
            setInterval(this.refreshPrice, 60000);
            let dark = localStorage.getItem('dark');
            if (dark === 'true') {
                let body = document.getElementsByTagName('body')[0];
                body.classList.add('grey', 'darken-1');
            }
        },
        methods: {
            darkMode() {
                let body = document.getElementsByTagName('body')[0];
                let clazz = body.classList;
                if (clazz.contains('grey')) {
                    clazz.remove('grey', 'darken-1');
                    localStorage.removeItem('dark');
                } else {
                    clazz.add('grey', 'darken-1');
                    localStorage.setItem('dark', 'true');
                }
            },
            pick(chip) {
                if (this.selectedChip) {
                    this.$set(this.selectedChip, 'selected', false);
                }

                localStorage.setItem('coin', chip.symbol);
                this.$set(chip, 'selected', true);
                this.selectedChip = chip;

                this.loadData(chip.symbol);
                // baca harga beli dan jual
                fetchPrice(chip.symbol).then(price => {
                    this.$set(this.price, 'buy', price.buy);
                    this.$set(this.price, 'sell', price.sell);
                    this.saveCoin(chip.symbol);
                });
            },
            loadData(symbol) {
                let data = localStorage.getItem(symbol);
                if (data) {
                    this.price = Object.assign(initPrice(), JSON.parse(data));
                } else {
                    this.price = initPrice();
                }
            },
            selectedColor(chip) {
                if (chip.selected) return 'green lighten-1';
                return '';
            },
            trendingColor(change) {
                if (change > 0) {
                    return 'green-text';
                } else if (change < 0) {
                    return 'red-text';
                } else return '';
            },
            contact() {
                copyText('@jajanjawa');
                M.toast({html: 'username disalin', displayLength: 1700});
            },
            invite() {
                copyText('EXPLO190');
                M.toast({html: 'kode undangan disalin', displayLength: 1700});
            },
            refreshPrice() {
                fetchPrice(this.selectedChip.symbol).then(price => {
                    this.$set(this.price, 'buy', price.buy);
                    this.$set(this.price, 'sell', price.sell);
                    this.saveCoin(this.selectedChip.symbol);
                });
            },
            async priceHour(symbol) {
                // perubahan dalam persen
                let now = await fetchRate(symbol);
                let hourAgo = await fetchRate(symbol, now.block - 3600);
                let change = calcPriceChange(now.close, hourAgo.close);
                // harga tinggi dan rendah
                let chart = await fetchChart(symbol, 'hour');
                let hl = getHighLow(chart);

                this.$set(this.price.hour, 'change', change);
                this.$set(this.price.hour, 'high', hl.high);
                this.$set(this.price.hour, 'low', hl.low);

                this.saveCoin(symbol);
            },
            async priceDay(symbol) {
                // perubahan dalam persen
                let now = await fetchRate(symbol);
                let dayAgo = await fetchRate(symbol, now.block - 86400);
                let change = calcPriceChange(now.close, dayAgo.close);
                // harga tinggi dan rendah
                let chart = await fetchChart(symbol, 'day');
                let hl = getHighLow(chart);

                this.$set(this.price.day, 'change', change);
                this.$set(this.price.day, 'high', hl.high);
                this.$set(this.price.day, 'low', hl.low);

                this.saveCoin(symbol);
            },
            /**
             *
             * @param symbol
             * @param time week,month,year
             * @returns {Promise<void>}
             */
            async priceTimelapse(symbol, time) {
                // perubahan dalam persen
                let chart = await fetchChart(symbol, time);
                let latestPrice = chart[0].close;
                let timePrice = chart[chart.length - 1].close;
                let change = calcPriceChange(latestPrice, timePrice);
                // harga tinggi dan rendah
                let hl = getHighLow(chart);

                this.$set(this.price[time], 'change', change);
                this.$set(this.price[time], 'high', hl.high);
                this.$set(this.price[time], 'low', hl.low);
                this.saveCoin(symbol);
            },
            saveCoin(symbol) {
                localStorage.setItem(symbol, JSON.stringify(this.price));
            }
        },
        filters: {
            fmtNumber(value) {
                if (value === undefined) return '0';
                if (typeof value === "string") {
                    value = parseInt(value);
                }
                return value.toLocaleString();
            },
            fmtPercent(value) {
                if (value === undefined || value === null) return '0%';
                return value.toFixed(2) + '%';
            }
        }

    });
</script>
</body>
</html>
