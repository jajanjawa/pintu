<!DOCTYPE html>
<html lang="id">
<head>
    <title>Pintu</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="css/materials-icon.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection"/>
    <link rel="icon" href="img/favicon.png">
</head>
<body>

<div class="container" id="app">
    <img src="img/pintu_logo_text.png" alt="Pintu" style="margin-top: 5px" class="responsive-img">

    <div class="row center">
        <div v-for="(it,index) in coinChips" :key="index" class="chip hoverable z-depth-1 waves-effect waves-ripple"
             :class="selectedColor(it)" @click="pick(it)" style="cursor: pointer">
            <img :src="it.icon" :alt="it.name">{{it.name}}
        </div>
    </div>

    <div class="row center">
        <!-- trending -->
        <table class="striped highlight centered">
            <tbody>
            <tr>
                <td class="waves-effect waves-ripple" @click="priceHour(selectedChip.symbol)" style="cursor: pointer">
                    Jam<br>
                    <span :class="trendingColor(price.hour.dir)">{{price.hour.change|fmtPercent}}</span>
                </td>
                <td class="waves-effect waves-ripple" @click="priceDay(selectedChip.symbol)" style="cursor: pointer">
                    Hari<br>
                    <span :class="trendingColor(price.day.dir)">{{price.day.change|fmtPercent}}</span>
                </td>
                <td class="waves-effect waves-ripple" @click="priceTimelapse(selectedChip.symbol, 'week')"
                    style="cursor: pointer">
                    Minggu<br>
                    <span :class="trendingColor(price.week.dir)">{{price.week.change|fmtPercent}}</span>
                </td>
                <td class="waves-effect waves-ripple" @click="priceTimelapse(selectedChip.symbol, 'month')"
                    style="cursor: pointer">
                    Bulan<br>
                    <span :class="trendingColor(price.month.dir)">{{price.month.change|fmtPercent}}</span>
                </td>
                <td class="waves-effect waves-ripple" @click="priceTimelapse(selectedChip.symbol, 'year')"
                    style="cursor: pointer">
                    Tahun<br>
                    <span :class="trendingColor(price.year.dir)">{{price.year.change|fmtPercent}}</span>
                </td>
            </tr>
            </tbody>
        </table>
        <!-- tinggi dan rendah -->
        <table class="centered striped highlight">
            <tbody>
            <tr>
                <td>Hari</td>
                <td class="green-text">{{price.day.high|fmtNumber}}</td>
                <td class="red-text">{{price.day.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Minggu</td>
                <td class="green-text">{{price.week.high|fmtNumber}}</td>
                <td class="red-text">{{price.week.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Bulan</td>
                <td class="green-text">{{price.month.high|fmtNumber}}</td>
                <td class="red-text">{{price.month.low|fmtNumber}}</td>
            </tr>
            <tr>
                <td>Year</td>
                <td class="green-text">{{price.year.high|fmtNumber}}</td>
                <td class="red-text">{{price.year.low|fmtNumber}}</td>
            </tr>
            </tbody>
        </table>
        <!-- harga beli dan jual -->
        <div class="col s6">
            <div class="chip green z-depth-1 hoverable waves-effect waves-ripple" @click="refreshPrice"
                 style="cursor: pointer">Beli: {{price.buy|fmtNumber}}
            </div>
        </div>
        <div class="col s6">
            <div class="chip red z-depth-1 hoverable waves-effect waves-ripple" @click="refreshPrice"
                 style="cursor: pointer">Jual: {{price.sell|fmtNumber}}
            </div>
        </div>
    </div>

    <!-- kontak -->
    <div class="row center">
        <div class="chip hoverable z-depth-1 waves-effect waves-ripple" @click="contact" style="cursor: pointer">
            <img src="img/favicon.png" alt="jajanjawa">@jajanjawa
        </div>
        <br>
        <div class="chip hoverable z-depth-1 waves-effect waves-ripple" @click="invite" style="cursor: pointer">
            <img src="img/favicon.png" alt="Undangan">Kode Undangan: EXPLO190
        </div>
        <br>
        <div class="chip hoverable z-depth-1 waves-effect waves-ripple" style="cursor: pointer" @click="openApp">
            <img src="img/favicon.png" alt="Pintu">Buka Pintu
        </div>
    </div>

    <div id="confirm" class="modal">
        <div class="modal-content">
            apa kamu yakin untuk buka <span class="green-text">Pintu</span> ?
        </div>
        <div class="modal-footer">
            <a href="pintu://" class="modal-close waves-effect waves-green btn-flat">Ya</a>
            <a href="#!" class="modal-close waves-effect waves-red btn-flat">Tidak</a>
        </div>
    </div>

</div>
<script src="js/materialize.min.js"></script>
<script src="js/vue.js"></script>
<script src="js/api.js"></script>
<script>
    function copyText(text) {
        let textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        textArea.remove();
    }

    function initPrice() {
        return {
            buy: 0, sell: 0, hour: {}, day: {}, week: {}, month: {}, year: {}
        };
    }

    let coinChips = [
        {icon: 'img/btc.webp', name: 'Bitcoin', symbol: 'btc', selected: true},
        {icon: 'img/eth.webp', name: 'Ethereum', symbol: 'eth'},
        {icon: 'img/bnb.webp', name: 'Binance Coin', symbol: 'bnb'},
        {icon: 'img/link.webp', name: 'Chainlink', symbol: 'link'},
        {icon: 'img/snx.webp', name: 'Synthetix', symbol: 'snx'},
        {icon: 'img/comp.webp', name: 'Compound', symbol: 'comp'},
    ]
    new Vue({
        el: '#app',
        data: {
            coinChips,
            coin: '',
            selectedChip: coinChips[0],
            price: initPrice()
        },
        mounted() {
            this.modal = M.Modal.init(document.querySelector('.modal'));
            this.loadData('btc');
        },
        computed: {},
        methods: {
            pick(chip) {
                if (this.selectedChip) {
                    this.$set(this.selectedChip, 'selected', false);
                    this.price = initPrice();
                }

                this.$set(chip, 'selected', true);
                this.selectedChip = chip;

                this.loadData(chip.symbol);
                // baca harga beli dan jual
                fetchPrice(chip.symbol).then(price => {
                    this.$set(this.price, 'buy', price.buy);
                    this.$set(this.price, 'sell', price.sell);
                    this.saveCoin(chip.symbol);
                });
            },
            loadData(symbol) {
                let data = localStorage.getItem(symbol);
                if (data) {
                    this.price = Object.assign(this.price, JSON.parse(data));
                }
            },
            selectedColor(chip) {
                if (chip.selected) return 'green lighten-1';
                return '';
            },
            trendingColor(dir) {
                if (dir > 0) {
                    return 'green-text';
                } else if (dir < 0) {
                    return 'red-text';
                } else return '';
            },
            contact() {
                copyText('@jajanjawa');
                M.toast({html: 'username disalin', displayLength: 1700});
            },
            invite() {
                copyText('EXPLO190');
                M.toast({html: 'kode undangan disalin', displayLength: 1700});
            },
            openApp() {
                this.modal.open();
            },
            refreshPrice() {
                fetchPrice(this.selectedChip.symbol).then(price => {
                    this.$set(this.price, 'buy', price.buy);
                    this.$set(this.price, 'sell', price.sell);
                    this.saveCoin(this.selectedChip.symbol);
                });
            },
            async priceHour(symbol) {
                let now = await fetchRate(symbol);
                let latestPrice = now.close;
                let block = now.block - 3600;
                let rateAgo = await fetchRate(symbol, block);
                let price = rateAgo.close;
                // perubahan dalam persen
                let change = calcPriceChange(latestPrice, price);
                let dir = change > 0 ? 1 : -1;

                this.$set(this.price.hour, 'change', change);
                this.$set(this.price.hour, 'dir', dir);
                this.saveCoin(symbol);
            },
            async priceDay(symbol) {
                let chart = await fetchChart(symbol, 'day');
                let block = chart[0].block - 86400;
                let result = await fetchRate(symbol, block);
                let price = result.close;
                // perubahan dalam persen
                let latestPrice = chart[0].close;
                let change = calcPriceChange(latestPrice, price);
                let dir = change > 0 ? 1 : -1;
                // harga tinggi dan rendah
                let hl = getHighLow(chart);

                this.$set(this.price.day, 'change', change);
                this.$set(this.price.day, 'dir', dir);
                this.$set(this.price.day, 'high', hl.high);
                this.$set(this.price.day, 'low', hl.low);

                this.saveCoin(symbol);
            },
            /**
             *
             * @param symbol
             * @param time week,month,year
             * @returns {Promise<void>}
             */
            async priceTimelapse(symbol, time) {
                let chart = await fetchChart(symbol, time);
                let latestPrice = chart[0].close;
                let timePrice = chart[chart.length - 1].close;
                let change = calcPriceChange(latestPrice, timePrice);
                let dir = change > 0 ? 1 : -1;
                // harga tinggi dan rendah
                let hl = getHighLow(chart);

                this.$set(this.price[time], 'change', change);
                this.$set(this.price[time], 'dir', dir);
                this.$set(this.price[time], 'high', hl.high);
                this.$set(this.price[time], 'low', hl.low);
                this.saveCoin(symbol);
            },
            saveCoin(symbol) {
                localStorage.setItem(symbol, JSON.stringify(this.price));
            }
        },
        filters: {
            fmtNumber(value) {
                if (value === undefined) return '0';
                if (typeof value === "string") {
                    value = parseInt(value);
                }
                return value.toLocaleString();
            },
            fmtPercent(value) {
                if (value === undefined) return '0%';
                return value.toFixed(2) + '%';
            }
        }

    });
</script>
</body>
</html>
